Modified from https://github.com/python/asyncio/tree/master